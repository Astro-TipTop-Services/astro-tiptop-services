"use strict";(self.webpackChunktiptop_site=self.webpackChunktiptop_site||[]).push([[8978],{6911:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>p,contentTitle:()=>l,default:()=>c,frontMatter:()=>a,metadata:()=>t,toc:()=>u});const t=JSON.parse('{"id":"orion/useful_scripts","title":"Useful Scripts & Companion Tools","description":"This section offers external tools and scripts developed","source":"@site/docs/orion/useful_scripts.mdx","sourceDirName":"orion","slug":"/orion/useful_scripts","permalink":"/astro-tiptop-services/docs/orion/useful_scripts","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"id":"useful_scripts","title":"Useful Scripts & Companion Tools","sidebar_label":"Useful Scripts & Companion Tools"},"sidebar":"tipTopSidebar","previous":{"title":"Interactive tools \u2013 Generate Input Files & Convert Parameters","permalink":"/astro-tiptop-services/docs/orion/interactivetools"},"next":{"title":"Parameter files explained","permalink":"/astro-tiptop-services/docs/orion/parameterfiles"}}');var i=r(4848),s=r(8453),o=r(9030);const a={id:"useful_scripts",title:"Useful Scripts & Companion Tools",sidebar_label:"Useful Scripts & Companion Tools"},l=void 0,p={},u=[{value:"Run <i>N</i> <strong>TipTop</strong> Simulations with Different Parameter Values",id:"run-n-tiptop-simulations-with-different-parameter-values",level:2},{value:"Rename Output FITS Files and Keep Backups",id:"rename-output-fits-files-and-keep-backups",level:2},{value:"Sum rotated PSF",id:"sum-rotated-psf",level:2}];function d(e){const n={a:"a",code:"code",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,s.R)(),...e.components},{Details:r}=n;return r||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)("div",{style:{textAlign:"justify"},children:(0,i.jsxs)(n.p,{children:["This section offers external tools and scripts developed\r\nto extend functionality, enhance, or automate ",(0,i.jsx)(n.strong,{children:"TipTop"})," workflows."]})}),"\n",(0,i.jsxs)(n.h2,{id:"run-n-tiptop-simulations-with-different-parameter-values",children:["Run ",(0,i.jsx)("i",{children:"N"})," ",(0,i.jsx)(n.strong,{children:"TipTop"})," Simulations with Different Parameter Values"]}),"\n",(0,i.jsx)("div",{style:{textAlign:"justify"},children:(0,i.jsxs)(n.p,{children:["Here, we provide an example script to run ",(0,i.jsx)("i",{children:"N"})," ",(0,i.jsx)(n.strong,{children:"TipTop"})," simulations with different values of two parameters:\r\n",(0,i.jsx)(n.code,{children:"ZenithAngle"})," and ",(0,i.jsx)(n.code,{children:"Seeing"}),". The script can easily be adapted to sweep over a single parameter or more than two."]})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Download the script:"}),"\r\n",(0,i.jsx)("a",{href:`${(0,o.Ay)("/downloads/TIPTOP_RUN_N_SIM.py")}`,download:"TIPTOP_RUN_N_SIM.py",children:(0,i.jsx)("span",{style:{fontSize:"1.5em"},children:"\ud83d\udce5"})}),"."]}),"\n",(0,i.jsxs)(r,{children:[(0,i.jsx)("summary",{children:(0,i.jsxs)("strong",{children:[" Running ",(0,i.jsx)("i",{children:"N"})," ",(0,i.jsx)(n.strong,{children:"TipTop"})," simulations: ",(0,i.jsx)(n.code,{children:"TIPTOP_RUN_N_SIM.py"})," "]})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'"""\r\nCreated on Thu Jul 10 10:00:34 2025\r\nRun N TIPTOP simulations by sweeping over different parameter values.\r\n\r\n@author: astro-tiptop-services\r\n"""\r\n\r\n#%% =============================================================================\r\n# Import necessary libraries\r\nfrom tiptop.tiptop import overallSimulation\r\nimport numpy as np\r\nimport configparser\r\nfrom itertools import product\r\nimport os\r\n\r\n#%% =============================================================================\r\n# === File Paths ===\r\n#\ud83d\udca1 Adapt these paths to your environment\r\ninputDir = "../MICADO/"   # Folder containing the .ini parameter file\r\ninTag = "MICADO_SCAO"     # Name of the input parameter file (without extension)\r\noutputDir = "./"          # Folder where the output FITS files will be saved \r\ntempDir = inputDir        # Temporary folder for modified .ini files\r\ntempName = \'file_temp\'    # Name of the temporary file\r\n\r\n# Construct the full path to the input and temporary config files\r\ninputFile = os.path.join(inputDir, f"{inTag}.ini")\r\ntempFile = os.path.join(tempDir, f"{tempName}.ini")\r\n\r\n# Base name for output files\r\noutTagBase = "MICADO"\r\n\r\n#%% =============================================================================\r\n# === Define parameters to sweep ===\r\n# \ud83d\udca1 Format: (section_name, key_name, list_of_values : min, max, number of values)\r\nparam_sweep = [\r\n  ("atmosphere", "Seeing", np.linspace(0.8, 2.0, 3)),\r\n  ("telescope", "ZenithAngle", np.linspace(0.0, 60.0, 3)),\r\n  # Add more parameters as needed\r\n]\r\n\r\n#%% =============================================================================\r\n# === Read base configuration file ===\r\nparser = configparser.ConfigParser()\r\nparser.optionxform = str # Keep the original case of parameter keys\r\nparser.read(inputFile)\r\n\r\n#%% =============================================================================\r\n# === Build and run combinations ===\r\n\r\n# Extract parameter names and values\r\nparam_names = [f"{sec}.{key}" for sec, key, _ in param_sweep]\r\nparam_values = [vals for _, _, vals in param_sweep]\r\n\r\n# Generate all combinations\r\nfor combo in product(*param_values):\r\n  # Update .ini with current parameter values\r\n  for (section, key, _), value in zip(param_sweep, combo):\r\n      parser.set(section, key, str(value))\r\n            \r\n      # Write updated config to temporary .ini file\r\n      with open(tempFile, "w") as configfile:\r\n          parser.write(configfile)\r\n      \r\n      # Build output file tag\r\n      tag_parts = [f"{name.split(\'.\')[-1]}{val:.2f}" for name, val in zip(param_names, combo)]\r\n      tag = f"{outTagBase}_{\'_\'.join(tag_parts)}"\r\n      \r\n      print(f"\ud83d\udd04 Running simulation with: {dict(zip(param_names, combo))}")\r\n      \r\n      # Run TipTop simulation\r\n      overallSimulation(\r\n          path2param=tempDir,\r\n          parametersFile=tempName,\r\n          outputDir=outputDir,\r\n          outputFile=tag,\r\n          addSrAndFwhm=True\r\n      )\n'})})]}),"\n",(0,i.jsx)(n.h2,{id:"rename-output-fits-files-and-keep-backups",children:"Rename Output FITS Files and Keep Backups"}),"\n",(0,i.jsx)("div",{style:{textAlign:"justify"},children:(0,i.jsxs)(n.p,{children:["This script renames PSF FITS files (e.g., those generated by the previous script)\r\nto facilitate their use in other routines, while creating backups of the originals.\r\nFor example, it renames FITS files in your folder starting with the tag MICADO\r\nto simple, easily readable names like ",(0,i.jsx)(n.code,{children:"MICADO_PSF1.fits"}),", ",(0,i.jsx)(n.code,{children:"MICADO_PSF2.fits"}),", and so on."]})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Download the script:"}),"\r\n",(0,i.jsx)("a",{href:`${(0,o.Ay)("/downloads/TIPTOP_rename_psf_files.py")}`,download:"TIPTOP_rename_psf_files.py",children:(0,i.jsx)("span",{style:{fontSize:"1.5em"},children:"\ud83d\udce5"})})]}),"\n",(0,i.jsxs)(r,{children:[(0,i.jsx)("summary",{children:(0,i.jsxs)("strong",{children:[" Rename output PSF FITS files: ",(0,i.jsx)(n.code,{children:"TIPTOP_rename_psf_files.py"})," "]})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'"""\r\nCreated on Thu Jul 10 14:15:45 2025\r\nRename output PSF FITS files sequentially for easier access and keep original copies.\r\n\r\n@author: astro-tiptop-services\r\n"""\r\n\r\n#%% =============================================================================\r\n# Import necessary libraries\r\nimport os\r\nimport shutil\r\n\r\n#%% =============================================================================\r\n# === Configuration ===\r\n#\ud83d\udca1 Adapt these paths to your environment\r\ninputDir = "./"    # Directory containing the generated FITS files \r\nbackupDir = "Original_PSFs"  # Directory to store backups of original files\r\noutputDir = "Renamed_PSFs" # Directory where renamed files will be moved (must exist)\r\n\r\nTagBase = "MICADO"     # Base name used in the output FITS filenames\r\n\r\n# Create output and backup directories if they do not exist\r\nos.makedirs(outputDir, exist_ok=True)\r\nos.makedirs(backupDir, exist_ok=True)\r\n\r\n#%% =============================================================================\r\n# === Gather and sort relevant FITS files ===\r\noutput_files = sorted(\r\n  [f for f in os.listdir(inputDir) if f.startswith(TagBase) and f.endswith(".fits")]\r\n)\r\n\r\n# Check if any matching files are found\r\nif not output_files:\r\n  print("[INFO] No matching FITS files found for renaming.")\r\nelse:\r\n  print(f"[INFO] Found {len(output_files)} FITS files to rename.")\r\n\r\n#%% =============================================================================\r\n# === Copy and Rename files sequentially as TagBase_PSF1.fits, MICADO_PSF2.fits, etc. ===\r\nfor i, fname in enumerate(output_files):\r\n  src = os.path.join(inputDir, fname)\r\n  dst = os.path.join(outputDir, f"{TagBase}_PSF{i+1}.fits")\r\n  backup = os.path.join(backupDir, fname)\r\n\r\n  try:\r\n      # Copy the original file to the backup folder\r\n      shutil.copy2(src, backup)\r\n\r\n      # Rename (and move) the file to the new destination\r\n      os.rename(src, dst)\r\n      print(f"[INFO] Renamed: {fname} \u2192 {TagBase}_PSF{i+1}.fits (Backup saved)")\r\n  except PermissionError:\r\n      print(f"[\u26a0\ufe0f  WARNING] File in use and cannot be renamed: {fname}")\r\n  except Exception as e:\r\n      print(f"[\u274c ERROR] Failed to rename {fname} \u2192 {e}")\r\n\r\n#%% =============================================================================\r\nprint(f"\\n\u2705 Process complete. {len(output_files)} files renamed and backed up.")\r\n\n'})})]}),"\n",(0,i.jsx)(n.h2,{id:"sum-rotated-psf",children:"Sum rotated PSF"}),"\n",(0,i.jsxs)("div",{style:{textAlign:"justify"},children:[(0,i.jsxs)(n.p,{children:["This script combines multiple PSFs into a single image by rotating each individual PSF\r\nby a specified field rotation angle before summation. ",(0,i.jsx)("br",{}),"\r\nUsed together with the two previous scripts, this process can be\r\nespecially useful, for example, when simulating long integrations to reproduce the impact of pupil rotation and field rotation on the final image."]}),(0,i.jsxs)(n.p,{children:["\u270f\ufe0f ",(0,i.jsx)(n.strong,{children:"Note"}),": You need to manually define the list of field rotation angles in the script \u2014 one angle per PSF FITS file.",(0,i.jsx)("br",{}),"\r\nFeel free to adapt this script to suit TipTop simulations involving multiple science sources.\r\nThe example provided here illustrates its use with the input parameter file\r\n",(0,i.jsx)(n.a,{href:"/docs/orion/aoinstruments#micado",children:"MICADO.ini"}),". ",(0,i.jsx)("br",{})]})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Download the script:"}),"\r\n",(0,i.jsx)("a",{href:`${(0,o.Ay)("/downloads/TIPTOP_rotated_PSF_sum.py")}`,download:"TIPTOP_rotated_PSF_sum.py",children:(0,i.jsx)("span",{style:{fontSize:"1.5em"},children:"\ud83d\udce5"})})]}),"\n",(0,i.jsxs)(r,{children:[(0,i.jsx)("summary",{children:(0,i.jsxs)("strong",{children:[" Sum rotated AO PSFs: ",(0,i.jsx)(n.code,{children:"TIPTOP_rotated_PSF_sum.py"})," "]})}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'"""\r\nCreated on Thu Jul 10 15:01:55 2025\r\nSum rotated PSFs.\r\nEach PSF is rotated by a specified angle before summation.\r\n\r\n@author: astro-tiptop-services\r\n"""\r\n\r\n#%% =============================================================================\r\n# Import necessary libraries\r\nimport os\r\nimport numpy as np\r\nfrom scipy.ndimage import rotate\r\nfrom astropy.io import fits\r\n\r\n#%% =============================================================================\r\n# === Configuration ===\r\ninputDir = "Renamed_PSFs"           # Folder where the PSF FITS files are stored\r\nTagBase = "MICADO"                  # Base tag for the PSF files\r\noutputFile = "PSF_sum.fits"         # Filename for the combined output\r\n\r\n# Rotation angles (degrees) applied to each PSF before summation\r\nrotation_angles = [...] # \ud83d\udca1 To be defined\r\nN = len(rotation_angles)  # Should match the number of PSF files available\r\n\r\n#%% =============================================================================\r\n# === Load and combine rotated PSFs ===\r\nfirst_filename = os.path.join(inputDir, f"{TagBase}_PSF1.fits")\r\nif not os.path.exists(first_filename):\r\n  raise FileNotFoundError(f"Base file {first_filename} is missing. Check input directory.")\r\n\r\nfirst_img = fits.getdata(first_filename)\r\naccumulated = np.zeros_like(first_img, dtype=float)  # Accumulator for summing rotated PSFs\r\nvalid_count = 0  # Count how many files were found and used\r\n\r\n# Loop over all images and angles\r\nfor i in range(N):\r\n  filename = os.path.join(inputDir, f\'{TagBase}_PSF{i+1}.fits\')\r\n\r\n  # Check if file exists\r\n  if not os.path.exists(filename):\r\n      print(f"[WARNING] Missing file: {filename}")\r\n      continue\r\n\r\n  print(f"[INFO] Loading file: {filename}")\r\n  img = fits.getdata(filename)\r\n\r\n  # Rotate the image by the corresponding angle\r\n  rotated = rotate(img, angle=rotation_angles[i], reshape=False)\r\n\r\n  # Accumulate the rotated image\r\n  accumulated += rotated\r\n  valid_count += 1\r\n\r\n#%% =============================================================================\r\n# === Normalize and save result ===\r\nif valid_count > 0:\r\n  accumulated /= valid_count\r\n\r\n  # Save PSF sum to a FITS file, overwrite if exists\r\n  fits.writeto(outputFile, accumulated, overwrite=True)\r\n  print(f"[INFO] Combined PSF saved to: {outputFile}")\r\nelse:\r\n  print("[ERROR] No valid PSF files found. No output generated.")\r\n\n'})})]})]})}function c(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>a});var t=r(6540);const i={},s=t.createContext(i);function o(e){const n=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);